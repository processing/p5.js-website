---
import { type CollectionEntry } from "astro:content";
import BaseLayout from "./BaseLayout.astro";
import Image from "@components/Image/index.astro";
import { setJumpToState, type JumpToLink } from "../globals/state";
import { getCurrentLocale, getUiTranslator } from "../i18n/utils";
import { categories, categoryNames } from "../content/tutorials/config";

type TutorialEntry = CollectionEntry<"tutorials">;

const currentLocale = getCurrentLocale(Astro.url.pathname);
const t = await getUiTranslator(currentLocale);

const { entries } = Astro.props;

const sections = categories.map((slug) => {
  const name = categoryNames[slug];
  const sectionEntries = entries
    .filter((e: TutorialEntry) => e.data.category === slug)
    .sort(
      (a: TutorialEntry, b: TutorialEntry) =>
        (a.data.categoryIndex ?? 1000) - (b.data.categoryIndex ?? 1000)
    );

  return { slug, name, sectionEntries };
});

const pageJumpToLinks = categories.map((category) => ({
  url: `#${category}`,
  label: category
    .split("-")
    .map((word) => word[0].toUpperCase() + word.slice(1))
    .join(" "),
}));

setJumpToState({
  heading: t("Tutorials") as string,
  links: pageJumpToLinks as JumpToLink[],
});
---

<BaseLayout title="Tutorials">
  {
    sections.map(({ slug, name, sectionEntries }) => (
      <div class="mb-lg">
        <h2 id={slug} class="mb-lg">
          {name}
        </h2>
        <ul class="content-grid pb-4xl border-b border-sidebar-type-color">
          {sectionEntries.map((entry: TutorialEntry) => (
            <li class="col-span-3">
              <a
                href={`/tutorials/${entry.slug}`}
                class="group hover:no-underline"
              >
                {entry.data.featuredImageAlt && entry.data.featuredImage && (
                  <Image
                    src={entry.data.featuredImage}
                    alt={entry.data.featuredImageAlt}
                  />
                )}
                <p class="mt-sm text-body group-hover:underline">
                  {entry.data.title}
                </p>
                <p class="text-body-caption">{entry.data.description}</p>
              </a>
            </li>
          ))}
        </ul>
      </div>
    ))
  }
</BaseLayout>
