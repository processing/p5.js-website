---
import Footer from "@components/Footer/index.astro";
import Nav from "@components/Nav/index.astro";
import Settings from "@components/Settings/index.astro";
import RootPageHeader from "@/src/components/PageHeader/RootPage.astro";
import ItemPageHeader from "@/src/components/PageHeader/ItemPage.astro";
import HomePageHeader from "@/src/components/PageHeader/HomePage.astro";
import { getCurrentLocale, getUiTranslator } from "@i18n/utils";
import { capitalize, getTopicInfo, type PageTopic } from "../pages/_utils";
import "@styles/base.scss";
import type { CollectionEntry } from "astro:content";
import { getCollectionInLocaleWithFallbacks } from "@pages/_utils";
import { removeLocalePrefix } from "@i18n/utils";

interface Props {
  title: string;
  titleAuthor?: string;
  titleClass?: string;
  subtitle?: string | null;
  className?: string;
  variant?: "root" | "item" | "search" | "homepage";
  topic?: PageTopic;
  mainContentParentClass?: string;
  /* Only needed for the homepage */
  homepageConfig?: CollectionEntry<"homepage">;
}

const {
  title,
  titleAuthor,
  titleClass = title,
  subtitle,
  className = "",
  variant = "root",
  mainContentParentClass = "mx-5 md:mx-lg mt-md",
  homepageConfig,
} = Astro.props;

const currentLocale = getCurrentLocale(Astro.url.pathname);

const slug = title.toLowerCase().split(/\s+|\./).join('-');
const pages = await getCollectionInLocaleWithFallbacks("pages", currentLocale);
const headerPage = pages.find((page) => removeLocalePrefix(page.slug).slice(1) === slug);
let HeaderContent: any = undefined;
if (headerPage) {
  const { Content } = await headerPage.render();
  HeaderContent = Content;
}

const t = await getUiTranslator(currentLocale);
const localizedTitle = t(title);
const localizedSubtitle = subtitle
  ? t(subtitle)
  : subtitle === undefined
    ? t("briefPageDescriptions", title)
    : undefined;
const topic = getTopicInfo(Astro.props.topic);
const splitPathname = Astro.url.pathname.split("/");
const fallbackTopic = splitPathname[splitPathname.length - 2];
const headerTopic = topic
  ? { name: t(topic.name) as string, url: topic.url }
  : { name: t(capitalize(fallbackTopic)) as string, url: `/${fallbackTopic}` };
---

<html
  class={`${titleClass.toLowerCase()} ${className} scroll-smooth`}
  lang={currentLocale}
>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
    <script is:inline>
      // Get any theme settings and apply before load
      const settings = [
        "dark-theme",
        "monochrome-theme",
        "show-alt-text",
        "reduced-motion",
      ];
      const storedSettings = settings.filter(
        (setting) => localStorage.getItem(setting) === "true"
      );
      if (storedSettings.length === 0) {
        storedSettings.push("light-theme");
      }
      const htmlElement = document.documentElement;
      htmlElement.className = `${storedSettings.join(" ")} ${htmlElement.className}`;
    </script>
    <link
      rel="stylesheet"
      href="https://foundation-donate-banner.netlify.app/static/css/main.css"
    />
    <script src="https://foundation-donate-banner.netlify.app/static/js/main.js"></script>
  </head>

  <body>
    <div class="top-layout-grid">
      <Nav />
      <Settings hideSearch={variant === "search"} />
      <header class={homepageConfig && "h-[100vh] md:min-h-[calc(378px+50vh)]"}>
        {
          variant === "root" ? (
            <RootPageHeader
              title={localizedTitle}
              subtitle={localizedSubtitle}
            />
          ) : variant === "item" ? (
            <ItemPageHeader
              title={localizedTitle as string}
              titleAuthor={titleAuthor}
              subtitle={localizedSubtitle as string}
              topic={headerTopic}
            />
          ) : (
            variant === "homepage" && (
              <HomePageHeader config={homepageConfig!} />
            )
          )
        }
      </header>
      <main id="main-content" class="relative">
        <div id="processing-banner" style="margin-left: var(--nav-offset-x);"></div>
        {
          HeaderContent && (
            <div class="px-5 md:px-lg pt-sm pb-lg">
              <div class="rendered-markdown">
                <HeaderContent />
              </div>
            </div>
          )
        }
        <div class={mainContentParentClass}>
          <slot />
          <script>
            function extractMermaid(text) {
              // strip YAML front-matter if present
              if (text.startsWith('---')) {
                const parts = text.split('\n');
                let i = 1;
                while (i < parts.length && parts[i] !== '---') i++;
                if (i < parts.length) text = parts.slice(i + 1).join('\n');
              }
              return text.trim();
            }

            function renderMermaid() {
              // 1) Convert fenced code blocks that look like Mermaid
              const mermaidHeads = new Set([
                'classDiagram','flowchart','graph','sequenceDiagram','stateDiagram',
                'erDiagram','journey','pie','gantt','mindmap','timeline','quadrantChart',
                'requirementDiagram','gitGraph'
              ]);

              const codeBlocks = document.querySelectorAll('pre code');
              codeBlocks.forEach((codeEl) => {
                const raw = extractMermaid(codeEl.textContent || '');
                const first = raw.split(/\s+/)[0];
                const isMermaid = codeEl.className.includes('language-mermaid') || mermaidHeads.has(first);
                if (!isMermaid) return;

                const pre = codeEl.closest('pre');
                const div = document.createElement('div');
                div.className = 'mermaid';
                div.textContent = raw; // pure Mermaid only
                if (pre && pre.parentNode) pre.parentNode.replaceChild(div, pre);
              });

              // 2) Render any <div class="mermaid"> now on the page
              if (window.mermaid) {
                window.mermaid.initialize({ startOnLoad: false, securityLevel: 'strict' });
                window.mermaid.run().catch((e) => console.error('[mermaid] render failed', e));
              } else {
                console.error('[mermaid] global mermaid not found');
              }
            }

            document.addEventListener('astro:page-load', renderMermaid);
            renderMermaid();
          </script>
        </div>
      </main>
      <Footer />
    </div>
  </body>
</html>
